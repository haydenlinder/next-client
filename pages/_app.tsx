import type { AppProps } from "next/app";
import Head from "next/head";
import Router from "next/router";
import { ApolloProvider, from, gql, useReactiveVar } from "@apollo/client";
import { useEffect, useState } from "react";

import { accessTokenState } from "../token";
import client, { authLink, errorLink, httpLink } from "./api/apollo-client";
import { Header } from "../components/Header";

import "../styles/build.css";

const baseUrl = typeof window === 'undefined' ? process.env.BASE_URL : ""

function MyApp({ Component, pageProps }: AppProps) {
  
  return (
    <ApolloProvider client={client}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header/>      
      <Main {...{Component, pageProps}}/>
    </ApolloProvider>
  );
}

const Main = ({ Component, pageProps }: Pick<AppProps, 'Component' | 'pageProps'>) => {
    const [loading, setLoading] = useState(true);
    const accessToken = useReactiveVar(accessTokenState);
    console.log({ accessToken })
    useEffect(() => {
      console.log('running');
      // see if we can get a new access token with our refresh token cookie
      (async () => {
        let access_token: string | undefined;
        try {
          const response = await refresh();
        access_token = response?.data?.access_token;
        accessTokenState(access_token)
      } catch (e) {
        console.log("REFRESH ERROR: ", { e })
      } finally {
        setLoading(false);
      }
      client.setLink(from([errorLink, authLink, httpLink]))
      if (!access_token) Router.replace('/login')
    })();
  }, []);

  if (loading) return <div>loading</div>

  return (
    <main className="max-h-screen min-h-screen flex justify-center overflow-y-scroll pt-28 pb-96">
      <div className="container h-screen flex flex-col items-center">
        <Component {...pageProps} />
      </div>
    </main>
  )
}

// const redirect = (res: AppContext['ctx']['res'], location: string) => {
//   if (res) { // server
//     !res.headersSent && res.writeHead(302, {
//       Location: location
//     }).end();
//   } else { // client
//     Router.push(location)
//   }
// }

const refresh = async () => {
  const response = await fetch(baseUrl + "/api/session/refresh");
  const data = await response.json();
  if (response.status !== 200) return undefined
  return data;
};

// const auth = async () => {
//   const response = await fetch(baseUrl + "/api/session/auth", { headers: { "Authorization": `Bearer ${getToken()}` } });
//   const data = await response.json();
//   if (response.status === 200) return true;
//   return false;
// };

export default MyApp;
